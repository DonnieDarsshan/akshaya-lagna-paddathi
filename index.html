<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Akshaya Lagna Paddathi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">







<style>
/* =========================================================
   COSMIC VEDIC GOLD â€“ FINAL FIXED
   Center INSIDE boxes only â€¢ Original layout preserved
   ========================================================= */

:root{
  --bg-main: radial-gradient(circle at top,#020617,#000000);
  --panel-bg: linear-gradient(180deg,#020617,#020617dd);

  --gold-main:#facc15;
  --gold-soft:#fde047;
  --saffron:#ff9f1c;
  --bronze:#92400e;

  --text-main:#f8fafc;
  --text-dim:#93c5fd;

  --border-soft:#334155;
  --border-gold:#a16207;

  --glow-gold:0 0 12px rgba(250,204,21,.45);
}

/* ================== BODY ================== */
body{
  background:var(--bg-main);
  color:var(--text-main);
  font-family:Segoe UI,Arial,sans-serif;
  padding:20px;
  max-width:1300px;
  margin:auto;
}

/* ================== HEADINGS (ALL TABLE TITLES) ================== */
h1,
h2{
  color:var(--gold-main) !important;
  text-shadow:var(--glow-gold);
  letter-spacing:1.4px;
}

/* ================== PANELS ================== */
.panel,
.alp-changer{
  background:var(--panel-bg);
  border:1px solid var(--border-soft);
  border-radius:12px;
}

/* ================== ROWS (ORIGINAL FLOW) ================== */
.row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
}

/* ================== INPUTS (TEXT CENTER ONLY) ================== */
input,
select,
button{
  background:#020617;
  color:var(--text-main);
  border:1px solid var(--border-soft);
  padding:6px 10px;
  border-radius:8px;
  font-weight:600;
  text-align:center;   /* âœ… inside box only */
}

button:hover{
  background:#1e293b;
  cursor:pointer;
  box-shadow:var(--glow-gold);
}

/* ================== TABLES ================== */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:14px;
  background:linear-gradient(180deg,#020617,#020617cc);
}

/* CENTER ONLY INSIDE CELLS */
th,
td{
  border:1px solid var(--border-soft);
  padding:7px;
  text-align:center;   /* âœ… inside box */
  vertical-align:middle;
}

/* TABLE HEADER CELLS */
th{
  background:linear-gradient(180deg,#1e293b,#020617);
  color:var(--gold-main);
  font-weight:900;
  letter-spacing:1px;
}

/* ================== TABLE ROW HOVER ================== */
tr:hover td{
  background:rgba(250,204,21,.08);
}

/* ================== TABLE-5 PLANET HEADING FIX ================== */
table tr th[colspan]{
  background:linear-gradient(180deg,#92400e,#1e293b);
  color:var(--gold-main);
  font-size:20px;
  font-weight:900;
  letter-spacing:2px;
  text-shadow:var(--glow-gold);
  border-bottom:2px solid var(--gold-main);
}

/* ================== ALP CHANGER (RESTORED) ================== */
.alp-changer-row{
  display:flex;
  align-items:center;
  gap:14px;
  flex-wrap:wrap;
  margin-bottom:10px;
}

.alp-label{
  font-size:17px;
  font-weight:800;
  color:var(--gold-main);
  min-width:260px;
}










	.alp-dates{
  font-size:16px;
  font-weight:800;
  letter-spacing:0.9px;

  color:#34d399; /* emerald green */

  text-shadow:
    0 0 6px rgba(52,211,153,0.55),
    0 0 14px rgba(16,185,129,0.35);

  padding:5px 12px;
  border-radius:9px;

  border:1px solid rgba(16,185,129,0.6);

  background:
    linear-gradient(
      180deg,
      rgba(2,6,23,0.92),
      rgba(2,6,23,0.72)
    );
}












/* ================== ALP BUTTONS ================== */
.alp-btn{
  font-size:20px;
  padding:8px 18px;
  border-radius:12px;
  font-weight:900;
  background:linear-gradient(135deg,#92400e,#020617);
  border:1px solid var(--border-gold);
  color:var(--gold-main);
}

.alp-btn:hover{
  box-shadow:var(--glow-gold);
}

/* ================== CHECKBOX / RADIO ================== */
input[type="checkbox"],
input[type="radio"]{
  accent-color:var(--gold-main);
}

/* ================== SCROLLBAR ================== */
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-thumb{
  background:linear-gradient(#92400e,#facc15);
  border-radius:10px;
}





/* =========================================================
   FIX-1 : Subtitle size restore (exact as original)
   ========================================================= */
.subtitle-inline{
  font-size:14px !important;
  font-weight:500 !important;
  opacity:.85 !important;
  line-height:1.4;
}






/* =========================================================
   TABLE-5 PLANET HEADERS
   MATCHES COSMIC VEDIC GOLD THEME (NO EXTRA DARK)
   ========================================================= */

#table3-shell table tr:first-child th[colspan]{
  /* SAME gold family as other tables */
  background:
    linear-gradient(
      180deg,
      #1e293b 0%,
      #020617 100%
    ) !important;

  color:#facc15 !important;        /* same gold */
  border-bottom:2px solid #a16207 !important;

  /* Polished depth (not dark) */
  box-shadow:
    inset 0 1px 0 rgba(250,204,21,0.18),
    inset 0 -1px 0 rgba(2,6,23,0.9),
    0 6px 18px rgba(0,0,0,0.6) !important;

  /* Typography harmony */
  font-size:20px !important;
  font-weight:900 !important;
  letter-spacing:2px;
  text-shadow:
    0 1px 0 #020617,
    0 0 8px rgba(250,204,21,0.35) !important;
}

/* Keep planet tables visually aligned with rest */
#table3-shell table{
  background:linear-gradient(180deg,#020617,#020617cc);
  border:1px solid #334155;
}









/* =========================================================
   COSMIC VEDIC GOLD â€“ SCROLLBAR FIX
   Matches full theme (no white strip)
   ========================================================= */

/* ===== Chrome / Edge / Brave / Opera ===== */
::-webkit-scrollbar{
  width:10px;
  height:10px;
}

::-webkit-scrollbar-track{
  background:#020617;              /* same as body */
  border-left:1px solid #334155;   /* subtle separation */
}

::-webkit-scrollbar-thumb{
  background:
    linear-gradient(
      180deg,
      #92400e 0%,
      #facc15 50%,
      #92400e 100%
    );
  border-radius:10px;
  border:2px solid #020617;        /* embeds thumb into theme */
}

::-webkit-scrollbar-thumb:hover{
  background:
    linear-gradient(
      180deg,
      #a16207 0%,
      #fde047 50%,
      #a16207 100%
    );
}

/* ===== Firefox ===== */
*{
  scrollbar-width: thin;
  scrollbar-color: #facc15 #020617;
}









/* =========================================================
   PERSISTENT ROW HIGHLIGHT (CLICK TO TOGGLE)
   ========================================================= */

		/* Default clickable row cursor */
		table tbody tr{
		  cursor:pointer;
		}

		/* Persistent selected row */
		tr.row-selected td{
		  background:
			linear-gradient(
			  180deg,
			  rgba(250,204,21,0.16),
			  rgba(250,204,21,0.09)
			) !important;

		  border-color:rgba(250,204,21,0.55) !important;

		  box-shadow:
			inset 0 0 0 1px rgba(250,204,21,0.45),
			inset 0 0 8px rgba(250,204,21,0.22);

		  font-weight:700;
		}

		/* Optional: subtle glow on text */
		tr.row-selected td{
		  text-shadow:0 0 6px rgba(250,204,21,0.55);
		}







</style>



















</head>

<body>

<h1>
  Akshaya Lagna Paddathi
  <span class="subtitle-inline">ALP Lagna progresses with time Â· Planets remain fixed</span>
</h1>




<div class="panel">
  <div class="row">
    <b>DOB</b>
    <input type="date" id="dob">

    <b>Transit</b>
    <input type="date" id="transitDate">
    <button id="todayBtn">Current Transit</button>

    <b>Move</b>
    <select id="stepSelect">
      <option value="1">1 Day</option>
      <option value="3">3 Days</option>
      <option value="5">5 Days</option>
      <option value="10">10 Days</option>
      <option value="15">Fortnight</option>
      <option value="30" selected>1 Month</option>
      <option value="91">3 Months</option>
      <option value="182.5">6 Months</option>
      <option value="365">1 Year</option>
    </select>
    <button id="prevBtn">â—€</button>
    <button id="nextBtn">â–¶</button>

    <label><input type="radio" name="houseSystem" value="Vedic"> Vedic</label>
    <label><input type="radio" name="houseSystem" value="KP" checked> KP</label>

    <label class="west-box">
      <input type="checkbox" id="westAspectToggle">
      West Asp (âˆ’180Â°)
    </label>
	
	<label class="west-box">
	  <input type="checkbox" id="signOnlyBhavaToggle">
	  Sign2Sign
	</label>
	
  </div>
</div>

	


<div class="panel">
  <div class="row">
    <b>Birth Lagna</b>

    <select id="birthSign"><option value="">Sign</option></select>
    <select id="birthDeg"><option value="">Deg</option></select>
    <select id="birthMin"></select>

    <!-- CURRENT AGE DISPLAY -->
    <div id="currentAgeBox"
         style="
           margin-left:14px;
           padding:6px 14px;
           border-radius:10px;
           font-weight:800;
           color:#34d399;
           border:1px solid rgba(16,185,129,0.6);
           background:linear-gradient(180deg,rgba(2,6,23,0.92),rgba(2,6,23,0.72));
           text-shadow:0 0 6px rgba(52,211,153,0.55);
         ">
      Age : â€”
    </div>
  </div>
</div>



<h2 style="
  margin-top:20px;
  margin-bottom:12px;
  text-align:center;
  color:#facc15;
  font-weight:900;
  letter-spacing:1.5px;
  text-shadow:0 0 10px #92400e;
">
TABLE-1 : DATA INPUT TABLE
</h2>




<table>
<thead>
<tr>
  <th>Planet</th>
  <th>Sign</th>
  <th>Deg</th>
  <th>Min</th>
  <th>Sec</th>
  <th>House</th>
  <th>Degree Diff</th>
  <th>Aspect</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>


<div class="panel">
  <button id="clearBtn">Clear All</button>
  <button id="saveBtn">Save Chart</button>
  <button id="loadBtn">Load Chart</button>
  <input type="file" id="fileInput" accept=".json" hidden>
</div>














<!-- =========================================================
     TABLE-2 : PLANET â†’ BIRTH NAKSHATRA FROM ALP (EXTENDED)
     ========================================================= -->

<h2 style="
  margin-top:30px;
  margin-bottom:12px;
  text-align:center;
  color:#86efac;
  font-weight:900;
  letter-spacing:1.5px;
  text-shadow:0 0 10px #064e3b;
">
TABLE-2 : PLANET BIRTH NAKSHATRA â†’ ALP LINK
</h2>

<table>
<thead>
<tr>
  <th>Planet</th>
  <th>From ALP (Planet)</th>
  <th>Planets Lords</th>
  <th>Its Original Nakshatra</th>
  <th>Its Nakshatra Lord</th>
  <th>From ALP</th>
  <th>Lords of ALP</th>
</tr>
</thead>
<tbody id="table2Body"></tbody>
</table>

<script>
/* =========================================================
   TABLE-2 LOGIC (KP / VEDIC AWARE â€“ FINAL)
   ========================================================= */

function buildTable2(){

  const body = document.getElementById("table2Body");
  if(!body) return;

  body.innerHTML = "";

  const ORDER = [
    "Surya","Chandra","Mangala",
    "Rahu","Guru","Shani",
    "Budha","Ketu","Shukra"
  ];

  const NAK_SIZE  = 360 / 27;
  const PADA_SIZE = 360 / 108;

  ORDER.forEach(p=>{

    if(!data[p]?.sign) return;

    /* =====================================================
       ABS DEG : THIS PLANET (FIRST COLUMN REFERENCE)
       ===================================================== */
    let planetAbs = absDeg(
      data[p].sign,
      +data[p].deg,
      +data[p].min,
      +data[p].sec
    );

    /* KP RULE : KETU ALWAYS OPPOSITE RAHU */
    if(p === "Ketu" && data["Rahu"]?.sign){
      const rAbs = absDeg(
        data["Rahu"].sign,
        +data["Rahu"].deg,
        +data["Rahu"].min,
        +data["Rahu"].sec
      );
      planetAbs = (rAbs + 180) % 360;
    }

    /* =====================================================
       FROM ALP (PLANET ITSELF â€” KP / VEDIC)
       ===================================================== */
    const fromALP_Planet = getHouseFromALP(planetAbs);

    /* =====================================================
       PLANET LORDS (MATCHING CURRENT ALP)
       ===================================================== */
    const planetLords =
      getLordsOfPlanetFromALP(p).join(",");

    /* =====================================================
       ORIGINAL BIRTH NAKSHATRA
       ===================================================== */
    const nakIndex = Math.floor(planetAbs / NAK_SIZE);
    const pada     = Math.floor((planetAbs % NAK_SIZE) / PADA_SIZE) + 1;

    const nakName  = NAKSHATRAS[nakIndex][0];
    const starLord = LORD_MAP[NAKSHATRAS[nakIndex][1]];

    /* =====================================================
       FROM ALP (NAKSHATRA LORD â€” KP / VEDIC)
       ===================================================== */
   let fromALP_Star = "";

if(starLord && data[starLord]?.sign){

  let lordAbs = absDeg(
    data[starLord].sign,
    +data[starLord].deg,
    +data[starLord].min,
    +data[starLord].sec
  );

  if(starLord === "Ketu" && data["Rahu"]?.sign){
    const rAbs = absDeg(
      data["Rahu"].sign,
      +data["Rahu"].deg,
      +data["Rahu"].min,
      +data["Rahu"].sec
    );
    lordAbs = (rAbs + 180) % 360;
  }

  /* ðŸ”¥ ALWAYS USE LIVE KP / VEDIC LOGIC */
  fromALP_Star = getHouseFromALP(lordAbs);
}


    /* =====================================================
       LORDS OF ALP (UNCHANGED CORE LOGIC)
       ===================================================== */
    const lordsOfALP =
      starLord ? getLordsOfPlanetFromALP(starLord).join(",") : "";

    /* =====================================================
       OUTPUT ROW
       ===================================================== */
    body.innerHTML += `
      <tr>
        <td>${p}</td>
        <td>${fromALP_Planet}</td>
        <td>${planetLords}</td>
        <td>${nakName} â€“ Pada ${pada}</td>
        <td>${starLord}</td>
        <td>${fromALP_Star}</td>
        <td>${lordsOfALP}</td>
      </tr>
    `;
  });
}

/* =====================================================
   SAFE AUTO REFRESH (KP / VEDIC TOGGLE AWARE)
   ===================================================== */
if(!window.__TABLE2_FINAL_KP_VEDIC__){
  window.__TABLE2_FINAL_KP_VEDIC__ = true;
  const _origRecalc = recalc;
  recalc = function(){
    _origRecalc();
    buildTable2();
  };
}
</script>






















<h2 style="
  margin-top:30px;
  margin-bottom:12px;
  text-align:center;
  color:#93c5fd;
  font-weight:900;
  letter-spacing:1.5px;
">
TABLE-3 : ALP NAKSHATRA & BHAVA ANALYSIS
</h2>



<table>
<thead>
<tr>
  <th>ALP House</th>
  <th>Nakshatra &amp; Pada</th>
  <th>Nakshatra Lord</th>
  <th>House from ALP</th>
  <th>Lords of ALP</th>
  <th>From Its Bhava</th>
</tr>
</thead>
<tbody id="alpNakshatraBody"></tbody>
</table>










<div class="alp-changer">
  <div class="alp-changer-row">
    <button class="alp-btn" id="alpSignPrev">â—€</button>
    <div class="alp-label" id="alpSignLabel">â€”</div>
    <button class="alp-btn" id="alpSignNext">â–¶</button>
    <div class="alp-dates">
      From : <span id="alpSignStart">â€”</span> |
      To : <span id="alpSignEnd">â€”</span>
    </div>
  </div>

  <div class="alp-changer-row">
    <button class="alp-btn" id="alpPadaPrev">â—€</button>
    <div class="alp-label" id="alpPadaLabel">â€”</div>
    <button class="alp-btn" id="alpPadaNext">â–¶</button>
    <div class="alp-dates">
      From : <span id="alpPadaStart">â€”</span> |
      To : <span id="alpPadaEnd">â€”</span>
    </div>
  </div>
</div>








<!-- =========================================================
     TABLE-4 : KUNDALI LORDS FROM ALP (DARKER VARIANT)
     ========================================================= -->

<h2 style="
  margin-top:40px;
  margin-bottom:14px;
  text-align:center;
  color:#7dd3fc;
  font-weight:900;
  letter-spacing:2px;
  text-shadow:0 0 12px #0f172a;
">
TABLE-4 : KUNDALI LORDS FROM ALP
</h2>

<table style="
  background:linear-gradient(180deg,#020617,#020617cc);
  border:1px solid #1e293b;
">
<thead>
<tr>
  <th>House</th>
  <th>Zodiac Sign</th>
  <th>Sign Lord</th>
  <th>Lords of ALP</th>
  <th>From ALP</th>
  <th>From Its Bhava</th>
</tr>
</thead>
<tbody id="kundaliTable3Body"></tbody>
</table>













<script>
const EPS=1e-9;
const ALP_SPEED=3/365;

const SIGNS=["Aries","Taurus","Gemini","Cancer","Leo","Virgo","Libra","Scorpio","Sagittarius","Capricorn","Aquarius","Pisces"];

/* =========================================================
   RASI NAME MAP (ENGLISH â†’ INDIAN)
   ========================================================= */
const RASI_DUAL = {
  Aries: "Mesha",
  Taurus: "Vrisaba",
  Gemini: "Mithuna",
  Cancer: "Kataka",
  Leo: "Simha",
  Virgo: "Kanya",
  Libra: "Thula",
  Scorpio: "Vrischika",
  Sagittarius: "Dhanu",
  Capricorn: "Makara",
  Aquarius: "Kumbha",
  Pisces: "Meena"
};



const PLANETS=[
  "ALP",
  "Surya",
  "Chandra",
  "Mangala",
  "Rahu",
  "Guru",
  "Shani",
  "Budha",
  "Ketu",
  "Shukra"
];


const LORD_MAP={Sun:"Surya",Moon:"Chandra",Mars:"Mangala",Mercury:"Budha",Jupiter:"Guru",Venus:"Shukra",Saturn:"Shani",Rahu:"Rahu",Ketu:"Ketu"};

const NAKSHATRAS=[
["Ashwini","Ketu"],["Bharani","Venus"],["Krittika","Sun"],["Rohini","Moon"],
["Mrigashira","Mars"],["Ardra","Rahu"],["Punarvasu","Jupiter"],["Pushya","Saturn"],
["Ashlesha","Mercury"],["Magha","Ketu"],["Purva Phalguni","Venus"],["Uttara Phalguni","Sun"],
["Hasta","Moon"],["Chitra","Mars"],["Swati","Rahu"],["Vishakha","Jupiter"],
["Anuradha","Saturn"],["Jyeshtha","Mercury"],["Mula","Ketu"],["Purva Ashadha","Venus"],
["Uttara Ashadha","Sun"],["Shravana","Moon"],["Dhanishta","Mars"],["Shatabhisha","Rahu"],
["Purva Bhadrapada","Jupiter"],["Uttara Bhadrapada","Saturn"],["Revati","Mercury"]
];

const ASPECTS=[
{n:"Conjunction",d:0,o:8},{n:"Semi-Sextile",d:30,o:3},
{n:"Square",d:90,o:6},{n:"Trine",d:120,o:6},
{n:"Opposition",d:180,o:8}
];

const data={};
PLANETS.forEach(p=>data[p]={sign:"",deg:0,min:0,sec:0});

SIGNS.forEach(s=>birthSign.add(new Option(s,s)));
for(let i=0;i<30;i++)birthDeg.add(new Option(i,i));
for(let i=0;i<60;i++)birthMin.add(new Option(i,i));
birthMin.value="0";

function absDeg(sign,deg,min,sec=0){
  return SIGNS.indexOf(sign)*30 + deg + min/60 + sec/3600;
}

let manualALPAbs=null;

function computeALPAbs(){
  const birthAbs=absDeg(birthSign.value,+birthDeg.value,+birthMin.value);
  if(manualALPAbs!==null)return (manualALPAbs+360)%360;
  const days=(new Date(transitDate.value)-new Date(dob.value))/86400000;
  return (birthAbs + days*ALP_SPEED + 360)%360;
}
</script>













<script>
/* =========================================================
   SIGN-TO-SIGN BHAVA (IGNORE DEGREE MODE)
   ========================================================= */
function getSignToSignBhava(fromSign, toSign){
  if(!fromSign || !toSign) return "";
  const f = SIGNS.indexOf(fromSign);
  const t = SIGNS.indexOf(toSign);
  if(f < 0 || t < 0) return "";
  return ((t - f + 12) % 12) + 1;
}
</script>









<!-- ================== PART 2 ================== -->

<script>
/* ================== DATE DERIVATION ================== */

function alpAbsToDate(targetAbs){
  const birthAbs = absDeg(birthSign.value,+birthDeg.value,+birthMin.value);
  const delta = (targetAbs - birthAbs + 360) % 360;
  const days = delta / ALP_SPEED;
  const d = new Date(dob.value);
  d.setDate(d.getDate() + Math.round(days));
  return d.toISOString().split("T")[0];
}

/* ================== BUILD TABLE ================== */

function buildTable(){
  tableBody.innerHTML="";
  PLANETS.forEach(p=>{
    if(p==="ALP"){
      tableBody.innerHTML+=`
      <tr>
        <td>ALP</td>
        <td id="alp_sign"></td>
        <td id="alp_deg"></td>
        <td id="alp_min"></td>
        <td id="alp_sec"></td>
        <td id="house_ALP"></td>
        <td id="diff_ALP"></td>
        <td id="aspect_ALP"></td>
      </tr>`;
    }else{
      tableBody.innerHTML+=`
      <tr>
        <td>${p}</td>

        <td>
          <select data-p="${p}" data-t="sign">
            <option></option>
            ${SIGNS.map(s=>`<option>${s}</option>`).join("")}
          </select>
        </td>

        <td>
          <select data-p="${p}" data-t="deg">
            ${[...Array(30).keys()].map(i=>`<option>${i}</option>`).join("")}
          </select>
        </td>

        <td>
          <select data-p="${p}" data-t="min">
            ${[...Array(60).keys()].map(i=>`<option>${i}</option>`).join("")}
          </select>
        </td>

        <td>
          <select data-p="${p}" data-t="sec">
            ${[...Array(60).keys()].map(i=>`<option>${i}</option>`).join("")}
          </select>
        </td>

        <td id="house_${p}"></td>
        <td id="diff_${p}"></td>
        <td id="aspect_${p}"></td>
      </tr>`;
    }
  });

  tableBody.querySelectorAll("select").forEach(sel=>{
    const p = sel.dataset.p;
    const t = sel.dataset.t;
    sel.value = data[p][t] ?? "";
    sel.onchange = ()=>{
      data[p][t] = sel.value;
      recalc();
    };
  });
}


/* ================== ASPECT ================== */

function getAspect(diff){
  for(const a of ASPECTS){
    if(Math.abs(diff-a.d)<=a.o || Math.abs(360-diff-a.d)<=a.o){
      return a.n;
    }
  }
  return "";
}

/* ================== RECALC (FIXED WEST ASP LOGIC) ================== */

function recalc(){
  if(!dob.value||!transitDate.value||!birthSign.value||birthDeg.value==="")return;

  const alpAbs = computeALPAbs();
  const birthAbs = absDeg(birthSign.value,+birthDeg.value,+birthMin.value);

  const sIdx=Math.floor(alpAbs/30);
  const d=Math.floor(alpAbs%30);
  const m=Math.floor(((alpAbs%30)-d)*60);

  alp_sign.textContent = SIGNS[sIdx];
  alp_deg.textContent = d;
  alp_min.textContent = m;

  const diffBirth=(alpAbs-birthAbs+360)%360;
  house_ALP.textContent=Math.floor(diffBirth/30)+1;
  diff_ALP.textContent=diffBirth.toFixed(2)+"Â°";
  aspect_ALP.textContent=getAspect(diffBirth);





const hs = document.querySelector(
  'input[name="houseSystem"]:checked'
)?.value === "KP" ? "KP" : "VEDIC";

const westAsp=document.getElementById("westAspectToggle").checked;

PLANETS.forEach(p=>{
  if(p==="ALP"||!data[p].sign)return;

  let pAbs = absDeg(
    data[p].sign,
    +data[p].deg,
    +data[p].min,
    +data[p].sec
  );

  /* FORCE RAHUâ€“KETU OPPOSITION */
  if(p==="Ketu" && data["Rahu"].sign){
    const rAbs = absDeg(
      data["Rahu"].sign,
      +data["Rahu"].deg,
      +data["Rahu"].min,
      +data["Rahu"].sec
    );
    pAbs = (rAbs + 180) % 360;
  }

  /* PURE ANGULAR DISTANCE (DO NOT TOUCH) */
  const rawDiff = (pAbs - alpAbs + 360) % 360;

  /* âœ… CORRECT KP / VEDIC HOUSE LOGIC */
  let house;
  if(hs === "KP"){
    house = Math.floor(rawDiff / 30) + 1;
  }else{
    house = Math.floor((rawDiff + 15) / 30) + 1;
  }

  if(house > 12) house -= 12;

  document.getElementById("house_"+p).textContent = house;

  /* DISPLAY DEGREE DIFF ONLY */
  let showDiff = rawDiff;
  if(westAsp && showDiff > 181 && showDiff <= 359){
    showDiff = Math.abs(showDiff - 180);
  }

  document.getElementById("diff_"+p).textContent = showDiff.toFixed(2)+"Â°";
  document.getElementById("aspect_"+p).textContent = getAspect(showDiff);
});








  buildALPNakshatraTable(alpAbs);
}

/* ================== INIT ================== */

buildTable();
transitDate.value=new Date().toISOString().split("T")[0];

/* ================== EVENTS ================== */

/* ================== PATCH : INPUT RESET HANDLERS ================== */

/* ONLY REAL DATE / BIRTH CHANGES SHOULD RESET ALP */
["dob","transitDate","birthSign","birthDeg","birthMin"].forEach(id=>{
  document.getElementById(id).onchange = ()=>{
    manualALPAbs = null;
    recalc();
  };
});

/* WEST ASP TOGGLE â€” DISPLAY ONLY (NO RESET, NO DATE CHANGE) */
westAspectToggle.onchange = ()=>{
  recalc();
};


document.querySelectorAll('input[name="houseSystem"]').forEach(r=>{
  r.onchange=recalc;
});

todayBtn.onclick=()=>{
  manualALPAbs=null;
  transitDate.value=new Date().toISOString().split("T")[0];
  recalc();
};

prevBtn.onclick=()=>{
  const d=new Date(transitDate.value);
  d.setDate(d.getDate()-Number(stepSelect.value));
  transitDate.value=d.toISOString().split("T")[0];
  manualALPAbs=null;
  recalc();
};

nextBtn.onclick=()=>{
  const d=new Date(transitDate.value);
  d.setDate(d.getDate()+Number(stepSelect.value));
  transitDate.value=d.toISOString().split("T")[0];
  manualALPAbs=null;
  recalc();
};
</script>










<script>

/* =========================================================
   AGE CALCULATION FROM DOB (y m d)
   ========================================================= */
function getAgeFromDOB(targetDateStr){
  if(!dob.value || !targetDateStr) return "";

  const dobDate = new Date(dob.value);
  const target  = new Date(targetDateStr);

  let y = target.getFullYear() - dobDate.getFullYear();
  let m = target.getMonth()  - dobDate.getMonth();
  let d = target.getDate()   - dobDate.getDate();

  if(d < 0){
    m--;
    const prevMonth = new Date(target.getFullYear(), target.getMonth(), 0);
    d += prevMonth.getDate();
  }

  if(m < 0){
    y--;
    m += 12;
  }

  return `${y} y ${m} m ${d} d`;
}







/* =========================================================
   LIVE CURRENT AGE (DOB â†’ TRANSIT DATE)
   ========================================================= */
function updateCurrentAge(){

  const box = document.getElementById("currentAgeBox");
  if(!box) return;

  if(!dob.value || !transitDate.value){
    box.textContent = "Age : â€”";
    return;
  }

  const age = getAgeFromDOB(transitDate.value);

  box.textContent = `Age : ${age.replace(" y"," years")
                              .replace(" m"," months")
                              .replace(" d"," days")}`;
}




</script>
























<!-- ================== PART 3 ================== -->
<script>
/* ================== ALP â†’ NAKSHATRA TABLE ================== */

/* -------- SAFE NORMALIZATION (FIXES PADA BUG) -------- */
function norm360(x){
  return ((x % 360) + 360) % 360;
}

function buildALPNakshatraTable(alpAbs){

  alpNakshatraBody.innerHTML = "";

  const nakSize  = 360 / 27;
  const padaSize = 360 / 108;

  const base = norm360(alpAbs);

  for(let h=1; h<=12; h++){

    const deg = norm360(base + (h-1)*30);

    const nIndex = Math.floor(deg / nakSize);
    const pIndex = Math.floor((deg % nakSize) / padaSize) + 1;

    const lord = LORD_MAP[NAKSHATRAS[nIndex][1]];

    const lordHouseCell = document.getElementById("house_"+lord);
	const placedHouse  = lordHouseCell ? Number(lordHouseCell.textContent) : 0;

/* ================= FROM ITS BHAVA (INCLUSIVE KP COUNT) ================= */


let fromItsBhava = "";

const signOnly =
  document.getElementById("signOnlyBhavaToggle")?.checked;

if(placedHouse){

  if(signOnly){
    /* SIGN-TO-SIGN ONLY (IGNORE DEGREE) */
    const targetSign = data[lord]?.sign;
    const baseSign   = SIGNS[(getSignIndex(alpAbs) + h - 1) % 12];
    fromItsBhava = getSignToSignBhava(baseSign, targetSign);

  }else{
    /* DEGREE / KP LOGIC (EXISTING) */
    fromItsBhava = ((placedHouse - h + 12) % 12) + 1;
  }
}



    /* ðŸ”¥ ALAS LORDSHIP FROM PART 4.1 */
    const lordsOf = getLordsOfPlanetFromALP(lord).join(",");

    alpNakshatraBody.innerHTML += `
      <tr>
        <td>${h}</td>
        <td>${NAKSHATRAS[nIndex][0]} â€“ Pada ${pIndex}</td>
        <td>${lord}</td>
        <td>${placedHouse}</td>
        <td>${lordsOf}</td>
		<td>${fromItsBhava}</td>
      </tr>
    `;
  }
}

/* ================== PURE ALP CONTROLS ================== */

const PADA_SIZE = 360/108;
const NAK_SIZE  = 360/27;

function getSignIndex(abs){
  return Math.floor(norm360(abs) / 30);
}
function getNakIndex(abs){
  return Math.floor(norm360(abs) / NAK_SIZE);
}
function getPadaIndex(abs){
  return Math.floor(norm360(abs) / PADA_SIZE);
}

/* ================== UI DATE SYNC ================== */

function updateALPControls(alpAbs){

  const a = norm360(alpAbs);

  const sIdx = Math.floor(a / 30);
  alpSignLabel.textContent =
  SIGNS[sIdx] + " â€“ " + RASI_DUAL[SIGNS[sIdx]];


  const signStartAbs = sIdx * 30;
  const signEndAbs   = (sIdx + 1) * 30;

  alpSignStart.textContent = alpAbsToDate(signStartAbs);
  alpSignEnd.textContent   = alpAbsToDate(signEndAbs);

  const nIdx = Math.floor(a / NAK_SIZE);
  const pIdx = (Math.floor(a / PADA_SIZE) % 4) + 1;

  alpPadaLabel.textContent =
    NAKSHATRAS[nIdx][0] + " â€“ Pada " + pIdx;

  const padaIndex = Math.floor(a / PADA_SIZE);
  const padaStartAbs = padaIndex * PADA_SIZE;
  const padaEndAbs   = padaStartAbs + PADA_SIZE;

  alpPadaStart.textContent = alpAbsToDate(padaStartAbs);
  alpPadaEnd.textContent   = alpAbsToDate(padaEndAbs);
}

/* ================== SIGN BUTTONS ================== */

alpSignPrev.onclick = ()=>{
  if(!dob.value || !birthSign.value)return;
  const idx = (getSignIndex(computeALPAbs()) + 11) % 12;
  manualALPAbs = idx * 30;
  recalc();
};

alpSignNext.onclick = ()=>{
  if(!dob.value || !birthSign.value)return;
  const idx = (getSignIndex(computeALPAbs()) + 1) % 12;
  manualALPAbs = idx * 30;
  recalc();
};

/* ================== PADA BUTTONS ================== */

alpPadaPrev.onclick = ()=>{
  if(!dob.value || !birthSign.value)return;
  let idx = getPadaIndex(computeALPAbs()) - 1;
  if(idx < 0) idx = 107;
  manualALPAbs = (idx * PADA_SIZE) + (PADA_SIZE / 2);
  recalc();
};

alpPadaNext.onclick = ()=>{
  if(!dob.value || !birthSign.value)return;
  let idx = getPadaIndex(computeALPAbs()) + 1;
  if(idx > 107) idx = 0;
  manualALPAbs = (idx * PADA_SIZE) + (PADA_SIZE / 2);
  recalc();
};

/* ================== SAFE RECALC WRAP (DO NOT BREAK LOAD) ================== */

const __recalc_locked = recalc;
recalc = function(){
  if(!dob.value || !transitDate.value || !birthSign.value || birthDeg.value==="")return;
  __recalc_locked();
  updateALPControls(computeALPAbs());
};

/* ================== SAVE / LOAD / CLEAR ================== */

saveBtn.onclick = ()=>{
  const blob = new Blob([JSON.stringify({
    dob:dob.value,
    transit:transitDate.value,
    birth:{sign:birthSign.value,deg:birthDeg.value,min:birthMin.value},
    data,                 // includes sec automatically
    manualALPAbs
  },null,2)],{type:"application/json"});


  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="alp_chart.json";
  a.click();
};

loadBtn.onclick = ()=>fileInput.click();

fileInput.onchange = e=>{
  const r=new FileReader();
  r.onload=()=>{
    const o=JSON.parse(r.result);

    dob.value=o.dob||"";
    transitDate.value=o.transit||"";
    birthSign.value=o.birth?.sign||"";
    birthDeg.value=o.birth?.deg||"";
    birthMin.value=o.birth?.min||"0";

		Object.keys(data).forEach(p=>{
	  if(o.data && o.data[p]){
		data[p].sign = o.data[p].sign;
		data[p].deg  = o.data[p].deg;
		data[p].min  = o.data[p].min;
		data[p].sec  = o.data[p].sec ?? 0;
	  }
	});


    manualALPAbs=(o.manualALPAbs!==undefined)?o.manualALPAbs:null;

    buildTable();
    setTimeout(recalc,0);
  };
  r.readAsText(e.target.files[0]);
};

clearBtn.onclick = ()=>{
  if(!confirm("Clear entire chart?"))return;
  Object.keys(data).forEach(p=>data[p]={sign:"",deg:0,min:0});
  birthSign.value="";
  birthDeg.value="";
  birthMin.value="0";
  manualALPAbs=null;
  buildTable();
  recalc();
};

/* ================== INIT ALIGN ================== */

setTimeout(()=>{
  if(dob.value && transitDate.value && birthSign.value){
    updateALPControls(computeALPAbs());
  }
},200);
</script>









<!-- ================== PART 4.1 ================== -->
<script>
/* =========================================================
   PART 4.1 : SIGN LORDSHIP FROM ALP (OPTION B â€“ FINAL)
   Rahu/Ketu = Dispositor lordships + Dispositor placement
   ========================================================= */

const SIGN_LORD = {
  Aries:"Mangala", Taurus:"Shukra", Gemini:"Budha", Cancer:"Chandra",
  Leo:"Surya", Virgo:"Budha", Libra:"Shukra", Scorpio:"Mangala",
  Sagittarius:"Guru", Capricorn:"Shani", Aquarius:"Shani", Pisces:"Guru"
};

function getLordsOfPlanetFromALP(planet){

  if(!birthSign.value || birthDeg.value==="") return [];

  const alpAbs  = computeALPAbs();
  const alpSign = SIGNS[getSignIndex(alpAbs)];
  const start   = SIGNS.indexOf(alpSign);

  let houses = [];

  /* ---------- NORMAL SIGN OWNERSHIP ---------- */
  for(let i=0;i<12;i++){
    const sign = SIGNS[(start+i)%12];
    if(SIGN_LORD[sign] === planet){
      houses.push(i+1);
    }
  }

  /* ---------- RAHU / KETU (ALAS RULE) ---------- */
  if(planet==="Rahu" || planet==="Ketu"){

    const nodeSign = data[planet].sign;
    if(!nodeSign) return houses;

    const dispositor = SIGN_LORD[nodeSign];
    if(!dispositor) return houses;

    /* 1ï¸âƒ£ Dispositorâ€™s sign lordships */
    const dispLords = getLordsOfPlanetFromALP(dispositor);
    dispLords.forEach(h=>{
      if(!houses.includes(h)) houses.push(h);
    });

    /* 2ï¸âƒ£ Dispositorâ€™s placement house */
    const placedCell = document.getElementById("house_"+dispositor);
    if(placedCell){
      const placed = Number(placedCell.textContent);
      if(placed && !houses.includes(placed)){
        houses.push(placed);
      }
    }
  }

  return houses.sort((a,b)=>a-b);
}
</script>







































<script>
/* =========================================================
   TABLE-3 : KUNDALI LORDS FROM ALP
   FIXED : FROM ALP = LORD â†’ ALP DISTANCE
   SAME LOGIC AS TABLE-1 (KP / VEDIC)
   ========================================================= */

const SIGN_LORD_SIMPLE = {
  Aries:"Mangala", Taurus:"Shukra", Gemini:"Budha", Cancer:"Chandra",
  Leo:"Surya", Virgo:"Budha", Libra:"Shukra", Scorpio:"Mangala",
  Sagittarius:"Guru", Capricorn:"Shani", Aquarius:"Shani", Pisces:"Guru"
};

function getHouseFromALP(abs){
  const alpAbs = computeALPAbs();
  const rawDiff = (abs - alpAbs + 360) % 360;

  const hs = document.querySelector(
    'input[name="houseSystem"]:checked'
  )?.value || "KP";

  let house;
  if(hs === "KP"){
    house = Math.floor(rawDiff / 30) + 1;
  }else{
    house = Math.floor((rawDiff + 15) / 30) + 1;
  }

  if(house > 12) house -= 12;
  return house;
}

function buildKundaliLordsTable3(){

  const body = document.getElementById("kundaliTable3Body");
  if(!body || !birthSign.value || birthDeg.value==="") return;

  body.innerHTML = "";

  const alpAbs = computeALPAbs();
  const alpSignIndex = getSignIndex(alpAbs);

  for(let h=1; h<=12; h++){

    /* ---------- ZODIAC SIGN ROTATION FROM ALP ---------- */
    const sign = SIGNS[(alpSignIndex + h - 1) % 12];
    const signLord = SIGN_LORD_SIMPLE[sign];

    /* ---------- LORDS OF ALP ---------- */
    const lordsOfALP = getLordsOfPlanetFromALP(signLord).join(",");

    /* ---------- SIGN LORD ABS DEG ---------- */
    let lordAbs = null;

    if(data[signLord]?.sign){
      lordAbs = absDeg(
        data[signLord].sign,
        +data[signLord].deg,
        +data[signLord].min,
        +data[signLord].sec
      );
    }

    /* ---------- RAHU / KETU â†’ DISPOSITOR ONLY ---------- */
    if((signLord==="Rahu" || signLord==="Ketu") && data[signLord]?.sign){
      const disp = SIGN_LORD_SIMPLE[data[signLord].sign];
      if(data[disp]?.sign){
        lordAbs = absDeg(
          data[disp].sign,
          +data[disp].deg,
          +data[disp].min,
          +data[disp].sec
        );
      }
    }

    /* ---------- FROM ALP (CORRECT & TOGGLE AWARE) ---------- */
    const fromALP = lordAbs ? getHouseFromALP(lordAbs) : "";

    /* ---------- FROM ITS BHAVA (UNCHANGED) ---------- */
			let fromItsBhava = "";

		const signOnly =
		  document.getElementById("signOnlyBhavaToggle")?.checked;

		if(fromALP){

		  if(document.getElementById("signOnlyBhavaToggle")?.checked){
			const targetSign = data[signLord]?.sign;
			const baseSign   = sign;
			fromItsBhava = getSignToSignBhava(baseSign, targetSign);
		  }else{
			/* ðŸ”¥ KP / VEDIC AWARE */
			fromItsBhava = ((fromALP - h + 12) % 12) + 1;
		  }
		}



    body.innerHTML += `
      <tr>
        <td>${h}</td>
        <td>${sign}</td>
        <td>${signLord}</td>
        <td>${lordsOfALP}</td>
        <td>${fromALP}</td>
        <td>${fromItsBhava}</td>
      </tr>
    `;
  }
}

/* =========================================================
   SAFE AUTO-HOOK (NO BREAKING)
   ========================================================= */
if(!window.__T3_KUNDALI_FINAL_FIXED__){
  window.__T3_KUNDALI_FINAL_FIXED__ = true;
  const _origRecalc = recalc;
  recalc = function(){
    _origRecalc();
    buildKundaliLordsTable3();
  };
}
</script>






















<!-- =========================================================
     TABLE-4B : RAHU & KETU FROM ALP (FINAL)
     ========================================================= -->

<div style="height:18px;"></div>

<h2 style="
  margin-top:10px;
  margin-bottom:12px;
  text-align:center;
  color:#fda4af;
  font-weight:900;
  letter-spacing:1.8px;
  text-shadow:0 0 10px #450a0a;
">
TABLE-4B : RAHU & KETU FROM ALP
</h2>

<table style="
  background:linear-gradient(180deg,#020617,#020617cc);
  border:1px solid #3f1d1d;
">
<thead>
<tr>
  <th>Planet</th>
  <th>Zodiac Sign</th>
  <th>Dispositor</th>
  <th>Lords of ALP</th>
  <th>From ALP</th>
</tr>
</thead>
<tbody id="rahuketuTableBody"></tbody>
</table>

<script>
/* =========================================================
   TABLE-3B : RAHU & KETU (ALP PIVOT BASED â€“ COMPLETE)
   ========================================================= */

/* --- SAME HOUSE LOGIC AS TABLE-1 (KP / VEDIC) --- */
function getHouseFromALP_RK(abs){
  const alpAbs = computeALPAbs();
  const rawDiff = (abs - alpAbs + 360) % 360;

  const hs = document.querySelector(
    'input[name="houseSystem"]:checked'
  )?.value || "KP";

  let house;
  if(hs === "KP"){
    house = Math.floor(rawDiff / 30) + 1;
  }else{
    house = Math.floor((rawDiff + 15) / 30) + 1;
  }

  if(house > 12) house -= 12;
  return house;
}

/* --- BUILD TABLE-3B --- */
function buildRahuKetuTable(){

  const body = document.getElementById("rahuketuTableBody");
  if(!body) return;

  body.innerHTML = "";

  ["Rahu","Ketu"].forEach(node=>{

    if(!data[node]?.sign) return;

    const zodiacSign = data[node].sign;
    const dispositor = SIGN_LORD_SIMPLE[zodiacSign] || "";

    /* --- Absolute position of node --- */
    let nodeAbs = absDeg(
      data[node].sign,
      +data[node].deg,
      +data[node].min,
      +data[node].sec
    );

    /* --- KP RULE : Ketu always opposite Rahu --- */
    if(node === "Ketu" && data["Rahu"]?.sign){
      const rAbs = absDeg(
        data["Rahu"].sign,
        +data["Rahu"].deg,
        +data["Rahu"].min,
        +data["Rahu"].sec
      );
      nodeAbs = (rAbs + 180) % 360;
    }

    /* --- FROM ALP (DIRECT NODE â†’ ALP DISTANCE) --- */
    const fromALP = getHouseFromALP_RK(nodeAbs);

    /* --- LORDS OF ALP (EXISTING LOGIC) --- */
    const lordsOfALP = getLordsOfPlanetFromALP(node).join(",");

    body.innerHTML += `
      <tr>
        <td>${node}</td>
        <td>${zodiacSign}</td>
        <td>${dispositor}</td>
        <td>${lordsOfALP}</td>
        <td>${fromALP}</td>
      </tr>
    `;
  });
}




/* =========================================================
   FINAL GLOBAL HOOK â€” RAHU / KETU TABLE REFRESH
   ========================================================= */
if(!window.__FINAL_RAHU_KETU_REFRESH__){
  window.__FINAL_RAHU_KETU_REFRESH__ = true;

  const __finalRecalc = recalc;
  recalc = function(){
    __finalRecalc();
    if(typeof buildRahuKetuTable === "function"){
      buildRahuKetuTable();
    }
  };
}
</script>





<script>
/* =========================================================
   HARD BIND : RAHU / KETU TABLE REFRESH ON KP / VEDIC TOGGLE
   ========================================================= */

document
  .querySelectorAll('input[name="houseSystem"]')
  .forEach(radio=>{
    radio.addEventListener("change", ()=>{
      if(typeof buildRahuKetuTable === "function"){
        buildRahuKetuTable();
      }
    });
  });
</script>

















<div style="text-align:center;margin-bottom:16px;">
  <label style="font-weight:800;color:#facc15;margin-right:10px;">
    Sort Planet :
  </label>
  <select id="table5SortPlanet"
          style="padding:6px 14px;border-radius:8px;font-weight:800;">
    <option value="">Default Order</option>
    <option>Surya</option>
    <option>Chandra</option>
    <option>Mangala</option>
    <option>Rahu</option>
    <option>Guru</option>
    <option>Shani</option>
    <option>Budha</option>
    <option>Ketu</option>
    <option>Shukra</option>
  </select>
</div>













<!-- =========================================================
     PART 5 : TABLE-5 (PLANET ENTITY BOXES â€“ FINAL STABLE)
     ========================================================= -->

<h2 style="
  margin-top:40px;
  margin-bottom:14px;
  text-align:center;
  color:#ff9f1c;
  font-weight:900;
  letter-spacing:2px;
  text-shadow:0 0 12px #a86b17;
">
TABLE-5 : PLANET STARâ€“SUB LORD ANALYSIS (KP)
</h2>








<!-- ===== TABLE-3 SHELL ===== -->
<div id="table3-shell" style="margin-top:40px;"></div>

<script>
/* =========================================================
   PART 5.1 : ASPECT RULES (KP STANDARD)
   ========================================================= */
const T3_ASPECT_RULES = {
  Surya:[7],
  Chandra:[7],
  Budha:[7],
  Shukra:[7],
  Mangala:[4,7,8],
  Guru:[5,7,9],
  Shani:[3,7,10],
  Rahu:[5,7,9],
  Ketu:[5,7,9]
};

function getAspectHousesT3(planet, placed){
  if(!placed) return [];
  return (T3_ASPECT_RULES[planet] || []).map(d=>{
    let h = placed + d - 1;
    while(h > 12) h -= 12;
    return h;
  });
}

/* =========================================================
   PART 5.2 : KP STAR / SUB / STAR-OF-SUB
   ========================================================= */
function getStarLordT3(p){
  if(!data[p]?.sign) return "";
	  const abs = absDeg(
	  data[p].sign,
	  +data[p].deg,
	  +data[p].min,
	  +data[p].sec
	);

  const ni  = Math.floor(abs / (360/27));
  return LORD_MAP[NAKSHATRAS[ni][1]];
}




/* ================== KP SUB LORD (PROPORTIONAL â€“ FINAL CORRECT) ================== */
function getSubLordT3(p){
  if(!data[p]?.sign) return "";

  const abs = absDeg(
    data[p].sign,
    +data[p].deg,
    +data[p].min,
    +data[p].sec
  );

  const NAK_SIZE = 360 / 27;
  const nakIndex = Math.floor(abs / NAK_SIZE);
  const nakStart = nakIndex * NAK_SIZE;
  const offset   = abs - nakStart;

  const starLord = LORD_MAP[NAKSHATRAS[nakIndex][1]];

  // Vimshottari order + years (KP standard)
  const ORDER = [
    {p:"Ketu", y:7},
    {p:"Shukra", y:20},
    {p:"Surya", y:6},
    {p:"Chandra", y:10},
    {p:"Mangala", y:7},
    {p:"Rahu", y:18},
    {p:"Guru", y:16},
    {p:"Shani", y:19},
    {p:"Budha", y:17}
  ];

  // Rotate order to start from STAR LORD
  const start = ORDER.findIndex(o=>o.p===starLord);
  const seq = ORDER.slice(start).concat(ORDER.slice(0,start));

  let acc = 0;
  for(const o of seq){
    const span = (o.y / 120) * NAK_SIZE;
    acc += span;
    if(offset <= acc + 1e-9){
      return o.p;
    }
  }

  return "";
}


/* =========================================================
   PART 5.3 : BUILD ONE PLANET BOX
   ========================================================= */
function buildPlanetBoxT3(planet){

  const chain = [
    {k:"Planet", p:planet},
    {k:"Star Lord", p:getStarLordT3(planet)},
    {k:"Sub Lord", p:getSubLordT3(planet)},
    {k:"Star of Sub Lord", p:getStarLordT3(getSubLordT3(planet))}
  ];

  let html = `
  <table style="margin-bottom:26px;">
    <tr>
      <th colspan="7" style="
        font-size:20px;
        padding:12px;
        background:linear-gradient(180deg,#2a0f0f,#140707);
        color:#ff9f1c;
        border-bottom:2px solid #a86b17;">
        ${planet}
      </th>
    </tr>
    <tr>
      <th>Entity</th>
      <th>Planet</th>
      <th>Lords of</th>
      <th>Placed in</th>
      <th>Final</th>
      <th>Aspects</th>
      <th>Summation</th>
    </tr>
  `;

  chain.forEach(r=>{
    if(!r.p) return;

    const lords   = getLordsOfPlanetFromALP(r.p);
			let placed = 0;

		if(data[r.p]?.sign){
		  let abs = absDeg(
			data[r.p].sign,
			+data[r.p].deg,
			+data[r.p].min,
			+data[r.p].sec
		  );

		  if(r.p === "Ketu" && data["Rahu"]?.sign){
			const rAbs = absDeg(
			  data["Rahu"].sign,
			  +data["Rahu"].deg,
			  +data["Rahu"].min,
			  +data["Rahu"].sec
			);
			abs = (rAbs + 180) % 360;
		  }

		  /* ðŸ”¥ LIVE KP / VEDIC */
		  placed = getHouseFromALP(abs);
		}


    const finalV  = [...new Set([...lords, placed].filter(Boolean))].sort((a,b)=>a-b);
    const aspects = getAspectHousesT3(r.p, placed);
    const sum     = [...new Set([...finalV, ...aspects])].sort((a,b)=>a-b);

    html += `
    <tr>
      <td>${r.k}</td>
      <td>${r.p}</td>
      <td>${lords.join(",")}</td>
      <td>${placed || ""}</td>
      <td>${finalV.join(",")}</td>
      <td>${aspects.join(",")}</td>
      <td>${sum.join(",")}</td>
    </tr>`;
  });

  html += `</table>`;
  return html;
}

/* =========================================================
   PART 5.4 : BUILD TABLE-3 (9 PLANET BOXES)
   ========================================================= */
function buildTable3(){

  const shell = document.getElementById("table3-shell");
  if(!shell) return;

  shell.innerHTML = "";

	  const defaultOrder = [
	  "Surya","Chandra","Mangala","Rahu",
	  "Guru","Shani","Budha","Ketu","Shukra"
	];

	const sel = document.getElementById("table5SortPlanet");
	const selected = sel && sel.value ? sel.value : "";

	let order = [...defaultOrder];

		if(selected && order.includes(selected)){
		  const idx = order.indexOf(selected);

		  /* ðŸ”¥ ROTATE ORDER (NOT SORT) */
		  order = order.slice(idx).concat(order.slice(0, idx));
		}


	order.forEach(p=>{
	  shell.innerHTML += buildPlanetBoxT3(p);
	});

}





/* =========================================================
   PART 5.5 : SAFE AUTO-HOOK (NO DOUBLE REWRAP)
   ========================================================= */
if(!window.__T3_HOOKED__){
  window.__T3_HOOKED__ = true;
  const _origRecalc = recalc;
  recalc = function(){
    _origRecalc();
    buildTable2();   // ðŸ”¥ ADD THIS LINE
    buildTable3();
  };
}

</script>













<script>
document
  .getElementById("table5SortPlanet")
  ?.addEventListener("change", ()=>{
    if(typeof buildTable3 === "function"){
      buildTable3();
    }
  });
</script>










<script>
/* =========================================================
   SIGN-TO-SIGN TOGGLE â†’ AUTO REFRESH
   ========================================================= */
document
  .getElementById("signOnlyBhavaToggle")
  ?.addEventListener("change", ()=>{
    if(typeof recalc === "function") recalc();
  });
</script>





<script>
/* =========================================================
   FIX-4 : HARD FORCE REFALC ON KP / VEDIC TOGGLE
   (Ensures ALL tables recalc using LIVE house logic)
   ========================================================= */

document
  .querySelectorAll('input[name="houseSystem"]')
  .forEach(radio=>{
    radio.addEventListener("change", ()=>{
      if(typeof recalc === "function") recalc();
      if(typeof buildTable2 === "function") buildTable2();
      if(typeof buildKundaliLordsTable3 === "function") buildKundaliLordsTable3();
      if(typeof buildTable3 === "function") buildTable3();
    });
  });
</script>





<script>
/* =========================================================
   PERSISTENT ROW HIGHLIGHT (SURVIVES ALL RECALC / NAVIGATION)
   ========================================================= */

/* Memory store (clears only on page close) */
const __ROW_HIGHLIGHT_STORE__ = new Set();

/* Build unique key for each row */
function getRowKey(tr){
  const table = tr.closest("table");
  if(!table) return null;

  const tableIndex =
    Array.from(document.querySelectorAll("table")).indexOf(table);

  const rowIndex =
    Array.from(tr.parentNode.children).indexOf(tr);

  return tableIndex + "::" + rowIndex;
}

/* Apply stored highlights */
function applyStoredHighlights(){
  document.querySelectorAll("table").forEach((table, tIdx)=>{
    table.querySelectorAll("tbody tr").forEach((tr, rIdx)=>{
      const key = tIdx + "::" + rIdx;
      if(__ROW_HIGHLIGHT_STORE__.has(key)){
        tr.classList.add("row-selected");
      }
    });
  });
}

/* Click handler */
document.addEventListener("click", function(e){

  const tr = e.target.closest("tbody tr");
  if(!tr) return;

  const key = getRowKey(tr);
  if(!key) return;

  if(tr.classList.contains("row-selected")){
    tr.classList.remove("row-selected");
    __ROW_HIGHLIGHT_STORE__.delete(key);
  }else{
    tr.classList.add("row-selected");
    __ROW_HIGHLIGHT_STORE__.add(key);
  }
});

/* ðŸ”¥ HARD RE-APPLY after ANY table rebuild */
const __origRecalc_global = recalc;
recalc = function(){
  __origRecalc_global();
  applyStoredHighlights();
};

/* Initial safety */
setTimeout(applyStoredHighlights, 100);
</script>

















<!-- =========================================================
     TABLE-6 : RASI â†’ RASI PRE CALCULATED DATES
     ========================================================= -->

<h2 style="
  margin-top:40px;
  margin-bottom:14px;
  text-align:center;
  color:#fde047;
  font-weight:900;
  letter-spacing:2px;
  text-shadow:0 0 12px #92400e;
">
TABLE-6 : RASI â†’ RASI DATES (ALP)
</h2>

<table>
<thead>
<tr>
  <th>Rasi</th>
  <th>From</th>
  <th>To</th>
</tr>
</thead>
<tbody id="rasiDateBody"></tbody>
</table>



<!-- =========================================================
     TABLE-7 : NAKSHATRA â†’ PADA PRE CALCULATED DATES
     ========================================================= -->

<h2 style="
  margin-top:40px;
  margin-bottom:14px;
  text-align:center;
  color:#86efac;
  font-weight:900;
  letter-spacing:2px;
  text-shadow:0 0 12px #064e3b;
">
TABLE-7 : NAKSHATRA â†’ PADA DATES (ALP)
</h2>

<table>
<thead>
<tr>
  <th>Nakshatra</th>
  <th>Pada 1</th>
  <th>Pada 2</th>
  <th>Pada 3</th>
  <th>Pada 4</th>
</tr>
</thead>
<tbody id="nakshatraPadaBody"></tbody>
</table>

















<script>

/* =========================================================
   TABLE-6 : RASI â†’ RASI DATE CALCULATION
   ========================================================= */


function buildRasiDateTable(){

  const body = document.getElementById("rasiDateBody");
  if(!body || !dob.value || !birthSign.value) return;

  body.innerHTML = "";

  const birthAbs = absDeg(
    birthSign.value,
    +birthDeg.value,
    +birthMin.value
  );

  const startSignIndex = Math.floor(birthAbs / 30);

  for(let i=0;i<12;i++){

    const signIndex = (startSignIndex + i) % 12;
    const rasiName =
      SIGNS[signIndex] + " â€“ " + RASI_DUAL[SIGNS[signIndex]];

    const fromAbs = signIndex * 30;
    const toAbs   = fromAbs + 30;

    const fromDate = alpAbsToDate(fromAbs);
    const toDate   = alpAbsToDate(toAbs);

    const fromAge = getAgeFromDOB(fromDate);
    const toAge   = getAgeFromDOB(toDate);

    body.innerHTML += `
      <tr>
        <td>${rasiName}</td>
        <td>
          From : ${fromDate}<br>
          <span style="display:block;margin-top:4px;color:#fde047;">
            From : ${fromAge}
          </span>
        </td>
        <td>
          To : ${toDate}<br>
          <span style="display:block;margin-top:4px;color:#fde047;">
            To : ${toAge}
          </span>
        </td>
      </tr>
    `;
  }
}
</script>




<script>
/* =========================================================
   TABLE-7 : NAKSHATRA â†’ PADA DATE CALCULATION
   ========================================================= */

function buildNakshatraPadaTable(){

  const body = document.getElementById("nakshatraPadaBody");
  if(!body || !dob.value || !birthSign.value) return;

  body.innerHTML = "";

  const birthAbs = absDeg(
    birthSign.value,
    +birthDeg.value,
    +birthMin.value
  );

  const NAK_SIZE  = 360 / 27;
  const PADA_SIZE = 360 / 108;

  const startNakIndex = Math.floor(birthAbs / NAK_SIZE);

  for(let n=0;n<27;n++){

    const nakIndex = (startNakIndex + n) % 27;
    const nakName  = NAKSHATRAS[nakIndex][0];

    let row = `<tr><td>${nakName}</td>`;

    for(let p=0;p<4;p++){

      const padaIndex = (nakIndex * 4) + p;
      const padaStartAbs = padaIndex * PADA_SIZE;
      const padaEndAbs   = padaStartAbs + PADA_SIZE;

      const fromDate = alpAbsToDate(padaStartAbs);
      const toDate   = alpAbsToDate(padaEndAbs);

      const fromAge  = getAgeFromDOB(fromDate);
      const toAge    = getAgeFromDOB(toDate);

      row += `
        <td>
          From : ${fromDate}<br>
          To : ${toDate}
          <div style="height:6px;"></div>
          <span style="color:#86efac;">
            From : ${fromAge}<br>
            To : ${toAge}
          </span>
        </td>
      `;
    }

    row += `</tr>`;
    body.innerHTML += row;
  }
}



/* =========================================================
   AUTO REFRESH ON INIT + RECALC
   ========================================================= */

if(!window.__RASI_PADA_TABLES__){
  window.__RASI_PADA_TABLES__ = true;

  const _origRecalc = recalc;
  recalc = function(){
    _origRecalc();
    buildRasiDateTable();
    buildNakshatraPadaTable();
	updateCurrentAge();
  };
}

/* Initial load */
setTimeout(()=>{
  buildRasiDateTable();
  buildNakshatraPadaTable();
},200);
</script>


























</body>
</html>
